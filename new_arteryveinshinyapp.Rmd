```{r}
# Ouyang et al. ShinyCell: Simple and sharable visualisation of single-cell gene expression data. Bioinformatics, doi:10.1093/bioinformatics/btab209

#First, users can run the following code to check if the packages required by ShinyCell exist and install them if required:

reqPkg = c("data.table", "Matrix", "hdf5r", "reticulate", "ggplot2", 
           "gridExtra", "glue", "readr", "RColorBrewer", "R.utils", "Seurat")
newPkg = reqPkg[!(reqPkg %in% installed.packages()[,"Package"])]
if(length(newPkg)){install.packages(newPkg)}

reqPkg = c("shiny", "shinyhelper", "data.table", "Matrix", "DT", "hdf5r", 
           "reticulate", "ggplot2", "gridExtra", "magrittr", "ggdendro")
newPkg = reqPkg[!(reqPkg %in% installed.packages()[,"Package"])]
if(length(newPkg)){install.packages(newPkg)}

```

```{r}
library(Seurat)
library(ShinyCell)
devtools::install_github("thomasp85/patchwork")
library(patchwork)
devtools::install_github("SGDDNB/ShinyCell")
install.packages('rsconnect')     # package to interface shiny apps
library(rsconnect)
install.packages("remotes")
library(remotes)
remotes::install_github("s-u/base64enc") #version 0.1-4
library(base64enc)
install.packages("Matrix")
```

```{r}
getExampleData()                       # Download example dataset (~200 MB)
seu = readRDS("/Users/layteng/Library/CloudStorage/Box-Box/Loh Lab DropBox Files/Kairos/Kevin_scRNA_figures_2025/Kairos_sortedcells_UMAP_04042025_KJL.rds")
scConf = createConfig(seu)
showLegend(scConf)

showOrder(scConf)
?modMetaName
scConf = modMetaName(scConf, 
                     meta.to.mod = c("nUMI", "nGene", "pctMT", "pctHK"), 
                     new.name = c("No. UMIs", "No. detected genes",
                                  "% MT genes", "% HK genes"))
showLegend(scConf)


# Modify colours and labels
scConf = modColours(scConf, meta.to.mod = "seurat_clusters", 
                    new.colours= c("#696969","#660066","#8064A2","#F79646","#D0CD3E","#FF0000"))

scConf = modColours(scConf, meta.to.mod = "orig.ident", 
                    new.colours= c("#D0CD3E","#F79646","#FF0000","#8064A2","#660066","#696969"))

scConf = modLabels(scConf, meta.to.mod = "orig.ident", 
                   new.labels = c("Day 1 Primitive Streak", "Day 2 Dorsal lateral mesoderm","Day 3 Artery EC", "Day 3 Prevein EC","Day 4 Vein EC","Undifferentiated H1"))


class(scConf)


scConf = modLabels(scConf, meta.to.mod = "seurat_clusters", 
                   new.labels = c("Undifferentiated H1", "Day 4 Vein EC","Day 3 Prevein EC","Day 2 Dorsal lateral mesoderm","Day 1 Primitive Streak","Day 3 Artery EC"))

showLegend(scConf)

#open server.R in Rstudio, click on RunApp, set working directory
#https://htmlpreview.github.io/?https://github.com/SGDDNB/ShinyCell/blob/master/docs/4cloud.html

sessionInfo()
```

```{r}

#delete metadata
scConf = delMeta(scConf, c("RNA_snn_res.0.1"))
?addMeta
showLegend(scConf)

checkConfig(scConf, seu)

citation = list(
  author  = "Lay Teng Ang, Sherry Li Zheng, Kevin J. Liu, Anastasiia Masaltseva, et al.",
  title   = "A human vascular differentiation roadmap reveals vein developmental origins and cellular effects of risk group 4 viruses",
  journal = "XX",
  volume  = "XX",
  page    = "XX",
  year    = "2025", 
  doi     = "XX",
  link    = "https://www.XX")

str(seu)

```

```{r}

View(seu)

library(Seurat)

seu <- UpdateSeuratObject(seu)

makeShinyApp(seu, scConf, gene.mapping = TRUE, gex.assay = "RNA", gex.slot = c("data","scale.data","counts"), shiny.title = "A human vascular differentiation roadmap",shiny.dir = "artery-vein-scRNA-seq/", shiny.footnotes = citation, default.gene1 = "CDH5", default.gene2 = "SOX17",default.multigene = c("CXCR4","EFNB2","DLL4", "UNC5B", "APLN","NR2F2","FLRT2","NT5E","APLNR")) 

```


```{r}

rsconnect::setAccountInfo(name='anglab', token='B03405EB2F7887935D1507F272F7D552', secret='YVqNyUADcwRzMQRVk/Oj4/sqLGtY52BFhyexbQGk')
setwd("/Users/layteng/Library/CloudStorage/Box-Box/Loh Lab DropBox Files/Kairos/Kevin_scRNA_figures_2025/")
rsconnect::deployApp("/Users/layteng/Library/CloudStorage/Box-Box/Loh Lab DropBox Files/Kairos/Kevin_scRNA_figures_2025/artery-vein-scRNA-seq/")

options(rsconnect.max.bundle.size = 5000000000)  # 5 GB, for example

```

